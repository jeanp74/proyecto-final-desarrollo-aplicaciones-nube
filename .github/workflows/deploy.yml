name: Build & Push services to ACRs (monorepo)

on:
  push:
    branches: [ "main" ]
    paths:
      - "appointments-api/**"
      - "patients-api/**"
      - "doctors-api/**"
      - "pharmacy-api/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # ACR primario
          - service: appointments-api
            context: appointments-api
            image: appointments-api
            registry: primary
          - service: doctors-api
            context: doctors-api
            image: doctors-api
            registry: primary

          # ACR secundario
          - service: patients-api
            context: patients-api
            image: patients-api
            registry: secondary
          - service: pharmacy-api
            context: pharmacy-api
            image: pharmacy-api
            registry: secondary

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üè∑Ô∏è Set version tag (short sha)
        id: vars
        run: echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      # Selecciona el ACR seg√∫n el servicio de la matrix
      - name: üîß Select ACR for this service
        id: select-acr
        shell: bash
        run: |
          if [ "${{ matrix.registry }}" = "secondary" ]; then
            echo "LOGIN_SERVER=${{ secrets.ACR_LOGIN_SERVER2 }}" >> $GITHUB_OUTPUT
            echo "USERNAME=${{ secrets.ACR_USERNAME2 }}" >> $GITHUB_OUTPUT
            echo "PASSWORD=${{ secrets.ACR_PASSWORD2 }}" >> $GITHUB_OUTPUT
          else
            echo "LOGIN_SERVER=${{ secrets.ACR_LOGIN_SERVER }}" >> $GITHUB_OUTPUT
            echo "USERNAME=${{ secrets.ACR_USERNAME }}" >> $GITHUB_OUTPUT
            echo "PASSWORD=${{ secrets.ACR_PASSWORD }}" >> $GITHUB_OUTPUT
          fi

      - name: üîë Login to selected ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ steps.select-acr.outputs.LOGIN_SERVER }}
          username: ${{ steps.select-acr.outputs.USERNAME }}
          password: ${{ steps.select-acr.outputs.PASSWORD }}

      - name: üèóÔ∏è Build & Push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: true
          tags: |
            ${{ steps.select-acr.outputs.LOGIN_SERVER }}/${{ matrix.image }}:latest
            ${{ steps.select-acr.outputs.LOGIN_SERVER }}/${{ matrix.image }}:${{ steps.vars.outputs.TAG }}
          build-args: |
            VITE_API_BASE=/
          cache-from: type=gha
          cache-to: type=gha,mode=max
