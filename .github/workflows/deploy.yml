name: Build & Push services to ACRs (monorepo)

on:
  push:
    branches: [ "main" ]
    paths:
      - "appointments-api/**"
      - "patients-api/**"
      - "doctors-api/**"
      - "pharmacy-api/**"
      - "api-gateway/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # === ACR primario ===
          - service: appointments-api
            context: appointments-api
            image: appointments-api
            registry: primary
          - service: doctors-api
            context: doctors-api
            image: doctors-api
            registry: primary

          # === ACR secundario ===
          - service: patients-api
            context: patients-api
            image: patients-api
            registry: secondary
          - service: pharmacy-api
            context: pharmacy-api
            image: pharmacy-api
            registry: secondary

          # === ACR gateway ===
          - service: api-gateway
            context: api-gateway
            image: api-gateway
            registry: gateway

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Seleccionar credenciales segÃºn el ACR
      - name: ğŸ”§ Select ACR for this service
        id: select-acr
        shell: bash
        run: |
          case "${{ matrix.registry }}" in
            secondary)
              echo "LOGIN_SERVER=${{ secrets.ACR_LOGIN_SERVER2 }}" >> $GITHUB_OUTPUT
              echo "USERNAME=${{ secrets.ACR_USERNAME2 }}" >> $GITHUB_OUTPUT
              echo "PASSWORD=${{ secrets.ACR_PASSWORD2 }}" >> $GITHUB_OUTPUT
              ;;
            gateway)
              echo "LOGIN_SERVER=${{ secrets.ACR_LOGIN_SERVER_API_GATEWAY }}" >> $GITHUB_OUTPUT
              echo "USERNAME=${{ secrets.ACR_USERNAME_API_GATEWAY }}" >> $GITHUB_OUTPUT
              echo "PASSWORD=${{ secrets.ACR_PASSWORD_API_GATEWAY }}" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "LOGIN_SERVER=${{ secrets.ACR_LOGIN_SERVER }}" >> $GITHUB_OUTPUT
              echo "USERNAME=${{ secrets.ACR_USERNAME }}" >> $GITHUB_OUTPUT
              echo "PASSWORD=${{ secrets.ACR_PASSWORD }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: ğŸ”‘ Login to selected ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ steps.select-acr.outputs.LOGIN_SERVER }}
          username: ${{ steps.select-acr.outputs.USERNAME }}
          password: ${{ steps.select-acr.outputs.PASSWORD }}

      - name: ğŸ·ï¸ Set version tag (short sha)
        id: vars
        run: echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build & Push ${{ matrix.service }}
        run: |
          ACR=${{ steps.select-acr.outputs.LOGIN_SERVER }}
          IMG=${{ matrix.image }}
          TAG=${{ steps.vars.outputs.TAG }}
          CONTEXT=${{ matrix.context }}

          echo "ğŸš€ Building $IMG from context $CONTEXT"
          docker build -t $ACR/$IMG:latest -t $ACR/$IMG:$TAG $CONTEXT
          echo "ğŸ“¤ Pushing to $ACR"
          docker push $ACR/$IMG:latest
          docker push $ACR/$IMG:$TAG

